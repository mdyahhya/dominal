<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dominal AI - Diagnostic Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .test-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    
    .test-section h2 {
      color: #333;
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: auto;
    }
    
    .status-waiting {
      background: #ffc107;
      color: #000;
    }
    
    .status-testing {
      background: #2196F3;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .status-pass {
      background: #4caf50;
      color: white;
    }
    
    .status-fail {
      background: #f44336;
      color: white;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .test-details {
      background: white;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .test-details pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
    }
    
    .success-text {
      color: #4caf50;
      font-weight: bold;
    }
    
    .error-text {
      color: #f44336;
      font-weight: bold;
    }
    
    .info-text {
      color: #2196F3;
    }
    
    .warning-text {
      color: #ff9800;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      display: block;
      margin: 30px auto;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-top: 30px;
    }
    
    .summary h3 {
      margin-bottom: 10px;
    }
    
    .summary-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      display: block;
    }
    
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Dominal AI Diagnostic Test</h1>
    <p class="subtitle">Complete system health check for Groq API integration</p>
    
    <button id="runTestBtn" onclick="runAllTests()">‚ñ∂ Run All Tests</button>
    
    <!-- Test 1: Environment Check -->
    <div class="test-section">
      <h2>
        <span>1Ô∏è‚É£ Environment Check</span>
        <span class="status-badge status-waiting" id="status-1">WAITING</span>
      </h2>
      <div class="test-details" id="result-1" style="display:none;"></div>
    </div>
    
    <!-- Test 2: Netlify Function Availability -->
    <div class="test-section">
      <h2>
        <span>2Ô∏è‚É£ Netlify Function Availability</span>
        <span class="status-badge status-waiting" id="status-2">WAITING</span>
      </h2>
      <div class="test-details" id="result-2" style="display:none;"></div>
    </div>
    
    <!-- Test 3: Groq API Connection -->
    <div class="test-section">
      <h2>
        <span>3Ô∏è‚É£ Groq API Connection Test</span>
        <span class="status-badge status-waiting" id="status-3">WAITING</span>
      </h2>
      <div class="test-details" id="result-3" style="display:none;"></div>
    </div>
    
    <!-- Test 4: Llama Model Response -->
    <div class="test-section">
      <h2>
        <span>4Ô∏è‚É£ Llama 3.1 8B Model Test</span>
        <span class="status-badge status-waiting" id="status-4">WAITING</span>
      </h2>
      <div class="test-details" id="result-4" style="display:none;"></div>
    </div>
    
    <!-- Test 5: Custom Data Integration -->
    <div class="test-section">
      <h2>
        <span>5Ô∏è‚É£ Custom Data Integration</span>
        <span class="status-badge status-waiting" id="status-5">WAITING</span>
      </h2>
      <div class="test-details" id="result-5" style="display:none;"></div>
    </div>
    
    <!-- Test 6: Full Conversation Flow -->
    <div class="test-section">
      <h2>
        <span>6Ô∏è‚É£ Full Conversation Flow</span>
        <span class="status-badge status-waiting" id="status-6">WAITING</span>
      </h2>
      <div class="test-details" id="result-6" style="display:none;"></div>
    </div>
    
    <!-- Summary -->
    <div class="summary" id="summary" style="display:none;">
      <h3>üìä Test Summary</h3>
      <div class="summary-stats">
        <div class="stat">
          <span class="stat-number" id="totalTests">0</span>
          <span class="stat-label">Total Tests</span>
        </div>
        <div class="stat">
          <span class="stat-number" id="passedTests">0</span>
          <span class="stat-label">Passed ‚úÖ</span>
        </div>
        <div class="stat">
          <span class="stat-number" id="failedTests">0</span>
          <span class="stat-label">Failed ‚ùå</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    let testResults = {
      passed: 0,
      failed: 0,
      total: 6
    };

    function updateStatus(testNum, status, message) {
      const statusBadge = document.getElementById(`status-${testNum}`);
      const resultDiv = document.getElementById(`result-${testNum}`);
      
      statusBadge.className = `status-badge status-${status}`;
      statusBadge.textContent = status.toUpperCase();
      
      resultDiv.innerHTML = message;
      resultDiv.style.display = 'block';
      
      if (status === 'pass') testResults.passed++;
      if (status === 'fail') testResults.failed++;
    }

    function showSummary() {
      document.getElementById('summary').style.display = 'block';
      document.getElementById('totalTests').textContent = testResults.total;
      document.getElementById('passedTests').textContent = testResults.passed;
      document.getElementById('failedTests').textContent = testResults.failed;
    }

    async function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function test1_EnvironmentCheck() {
      updateStatus(1, 'testing', '<span class="info-text">Checking environment...</span>');
      await sleep(500);
      
      let results = [];
      let passed = true;
      
      // Check if running on Netlify
      const isNetlify = window.location.hostname.includes('netlify.app') || 
                        window.location.hostname.includes('.netlify.com');
      
      results.push(`<span class="${isNetlify ? 'success-text' : 'warning-text'}">` +
        `‚úì Running on: ${window.location.hostname}</span>`);
      
      if (!isNetlify) {
        results.push(`<span class="warning-text">‚ö† Not on Netlify domain. Functions may not work locally without Netlify CLI.</span>`);
      }
      
      results.push(`<span class="info-text">‚úì Protocol: ${window.location.protocol}</span>`);
      results.push(`<span class="info-text">‚úì Full URL: ${window.location.href}</span>`);
      
      // Check for HTTPS
      const isHTTPS = window.location.protocol === 'https:';
      results.push(`<span class="${isHTTPS ? 'success-text' : 'warning-text'}">` +
        `${isHTTPS ? '‚úì' : '‚ö†'} HTTPS: ${isHTTPS ? 'Enabled' : 'Disabled'}</span>`);
      
      updateStatus(1, passed ? 'pass' : 'fail', '<pre>' + results.join('\n') + '</pre>');
    }

    async function test2_FunctionAvailability() {
      updateStatus(2, 'testing', '<span class="info-text">Testing function endpoint...</span>');
      
      let results = [];
      let passed = false;
      
      try {
        results.push('<span class="info-text">‚Üí Attempting to reach: /.netlify/functions/chat</span>');
        
        const response = await fetch('/.netlify/functions/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: [] })
        });
        
        results.push(`<span class="info-text">‚Üí Response status: ${response.status}</span>`);
        results.push(`<span class="info-text">‚Üí Response OK: ${response.ok}</span>`);
        
        if (response.status === 404) {
          results.push('<span class="error-text">‚úó ERROR: Function not found (404)</span>');
          results.push('<span class="warning-text">Possible causes:</span>');
          results.push('  ‚Ä¢ Folder structure wrong (must be netlify/functions/chat.js)');
          results.push('  ‚Ä¢ Function not deployed on Netlify');
          results.push('  ‚Ä¢ netlify.toml missing or incorrect');
          passed = false;
        } else if (response.status === 500) {
          const errorText = await response.text();
          results.push('<span class="error-text">‚úó ERROR: Function crashed (500)</span>');
          results.push(`<span class="error-text">Error details: ${errorText}</span>`);
          passed = false;
        } else if (response.ok || response.status === 400) {
          // 400 is acceptable - means function exists but needs proper data
          results.push('<span class="success-text">‚úì Function endpoint is reachable!</span>');
          passed = true;
        } else {
          results.push(`<span class="warning-text">‚ö† Unexpected status: ${response.status}</span>`);
          const text = await response.text();
          results.push(`Response: ${text}`);
          passed = false;
        }
        
      } catch (error) {
        results.push('<span class="error-text">‚úó NETWORK ERROR</span>');
        results.push(`<span class="error-text">Error: ${error.message}</span>`);
        results.push('<span class="warning-text">Possible causes:</span>');
        results.push('  ‚Ä¢ Testing on localhost without Netlify CLI');
        results.push('  ‚Ä¢ CORS issue');
        results.push('  ‚Ä¢ Network connectivity problem');
        passed = false;
      }
      
      updateStatus(2, passed ? 'pass' : 'fail', '<pre>' + results.join('\n') + '</pre>');
      return passed;
    }

    async function test3_GroqAPIConnection() {
      updateStatus(3, 'testing', '<span class="info-text">Testing Groq API connection...</span>');
      
      let results = [];
      let passed = false;
      
      try {
        results.push('<span class="info-text">‚Üí Sending test message to Groq via Netlify function...</span>');
        
        const startTime = Date.now();
        
        const response = await fetch('/.netlify/functions/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role: 'user', content: 'Say "test successful" if you receive this.' }
            ]
          })
        });
        
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        results.push(`<span class="info-text">‚Üí Response time: ${responseTime}ms</span>`);
        results.push(`<span class="info-text">‚Üí Status code: ${response.status}</span>`);
        
        if (!response.ok) {
          const errorText = await response.text();
          results.push('<span class="error-text">‚úó API call failed</span>');
          results.push(`<span class="error-text">Error: ${errorText}</span>`);
          
          if (response.status === 401) {
            results.push('<span class="warning-text">‚ö† Authentication error - Check GROQ_API_KEY in Netlify env variables</span>');
          }
          passed = false;
        } else {
          const data = await response.json();
          results.push('<span class="success-text">‚úì Groq API responded successfully!</span>');
          results.push(`<span class="info-text">Response structure:</span>`);
          results.push(JSON.stringify(data, null, 2));
          passed = true;
        }
        
      } catch (error) {
        results.push('<span class="error-text">‚úó CONNECTION FAILED</span>');
        results.push(`<span class="error-text">Error: ${error.message}</span>`);
        passed = false;
      }
      
      updateStatus(3, passed ? 'pass' : 'fail', '<pre>' + results.join('\n') + '</pre>');
      return passed;
    }

    async function test4_LlamaModelTest() {
      updateStatus(4, 'testing', '<span class="info-text">Testing Llama 3.1 8B Instant model...</span>');
      
      let results = [];
      let passed = false;
      
      try {
        results.push('<span class="info-text">‚Üí Model: llama-3.1-8b-instant</span>');
        results.push('<span class="info-text">‚Üí Sending test prompt...</span>');
        
        const startTime = Date.now();
        
        const response = await fetch('/.netlify/functions/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role: 'user', content: 'What is 2+2? Answer with just the number.' }
            ]
          })
        });
        
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        if (!response.ok) {
          results.push('<span class="error-text">‚úó Model request failed</span>');
          const errorText = await response.text();
          results.push(`<span class="error-text">${errorText}</span>`);
          passed = false;
        } else {
          const data = await response.json();
          const modelResponse = data.choices?.[0]?.message?.content || 'No response';
          
          results.push(`<span class="success-text">‚úì Model response received in ${responseTime}ms</span>`);
          results.push(`<span class="info-text">‚Üí Model used: ${data.model || 'llama-3.1-8b-instant'}</span>`);
          results.push(`<span class="info-text">‚Üí Response: "${modelResponse}"</span>`);
          results.push(`<span class="info-text">‚Üí Tokens used: ${data.usage?.total_tokens || 'N/A'}</span>`);
          
          // Check if response makes sense
          if (modelResponse.toLowerCase().includes('4') || modelResponse.trim() === '4') {
            results.push('<span class="success-text">‚úì Model is responding intelligently!</span>');
            passed = true;
          } else {
            results.push('<span class="warning-text">‚ö† Response seems unusual but model is working</span>');
            passed = true; // Still pass if we got a response
          }
        }
        
      } catch (error) {
        results.push('<span class="error-text">‚úó MODEL TEST FAILED</span>');
        results.push(`<span class="error-text">Error: ${error.message}</span>`);
        passed = false;
      }
      
      updateStatus(4, passed ? 'pass' : 'fail', '<pre>' + results.join('\n') + '</pre>');
      return passed;
    }

    async function test5_CustomDataIntegration() {
      updateStatus(5, 'testing', '<span class="info-text">Testing custom data integration...</span>');
      
      let results = [];
      let passed = false;
      
      try {
        results.push('<span class="info-text">‚Üí Sending query about Yahya...</span>');
        
        const response = await fetch('/.netlify/functions/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { 
                role: 'system', 
                content: 'You are Dominal AI. Yahya is the founder of Dominal Group and a full-stack developer.' 
              },
              { 
                role: 'user', 
                content: 'Who is Yahya? Answer in one sentence.' 
              }
            ]
          })
        });
        
        if (!response.ok) {
          results.push('<span class="error-text">‚úó Custom data test failed</span>');
          passed = false;
        } else {
          const data = await response.json();
          const modelResponse = data.choices?.[0]?.message?.content || '';
          
          results.push('<span class="success-text">‚úì Model received custom data</span>');
          results.push(`<span class="info-text">Response: "${modelResponse}"</span>`);
          
          // Check if response mentions Yahya or Dominal
          if (modelResponse.toLowerCase().includes('yahya') || 
              modelResponse.toLowerCase().includes('dominal')) {
            results.push('<span class="success-text">‚úì Custom data is being used correctly!</span>');
            passed = true;
          } else {
            results.push('<span class="warning-text">‚ö† Response may not be using custom data properly</span>');
            passed = false;
          }
        }
        
      } catch (error) {
        results.push('<span class="error-text">‚úó CUSTOM DATA TEST FAILED</span>');
        results.push(`<span class="error-text">Error: ${error.message}</span>`);
        passed = false;
      }
      
      updateStatus(5, passed ? 'pass' : 'fail', '<pre>' + results.join('\n') + '</pre>');
      return passed;
    }

    async function test6_FullConversationFlow() {
      updateStatus(6, 'testing', '<span class="info-text">Testing full conversation flow...</span>');
      
      let results = [];
      let passed = false;
      
      try {
        results.push('<span class="info-text">‚Üí Simulating multi-turn conversation...</span>');
        
        // First message
        const response1 = await fetch('/.netlify/functions/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role: 'user', content: 'Hello! What is your name?' }
            ]
          })
        });
        
        if (!response1.ok) throw new Error('First message failed');
        
        const data1 = await response1.json();
        const reply1 = data1.choices?.[0]?.message?.content || '';
        
        results.push(`<span class="success-text">‚úì Message 1 sent & received</span>`);
        results.push(`  Response: "${reply1.substring(0, 100)}..."`);
        
        // Second message with context
        await sleep(1000);
        
        const response2 = await fetch('/.netlify/functions/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role: 'user', content: 'Hello!' },
              { role: 'assistant', content: reply1 },
              { role: 'user', content: 'What can you help me with?' }
            ]
          })
        });
        
        if (!response2.ok) throw new Error('Second message failed');
        
        const data2 = await response2.json();
        const reply2 = data2.choices?.[0]?.message?.content || '';
        
        results.push(`<span class="success-text">‚úì Message 2 sent & received</span>`);
        results.push(`  Response: "${reply2.substring(0, 100)}..."`);
        
        results.push('<span class="success-text">‚úì Full conversation flow working!</span>');
        results.push(`<span class="info-text">Total tokens used: ${(data1.usage?.total_tokens || 0) + (data2.usage?.total_tokens || 0)}</span>`);
        
        passed = true;
        
      } catch (error) {
        results.push('<span class="error-text">‚úó CONVERSATION FLOW FAILED</span>');
        results.push(`<span class="error-text">Error: ${error.message}</span>`);
        passed = false;
      }
      
      updateStatus(6, passed ? 'pass' : 'fail', '<pre>' + results.join('\n') + '</pre>');
      return passed;
    }

    async function runAllTests() {
      const btn = document.getElementById('runTestBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Testing...';
      
      testResults = { passed: 0, failed: 0, total: 6 };
      
      // Reset all statuses
      for (let i = 1; i <= 6; i++) {
        document.getElementById(`status-${i}`).className = 'status-badge status-waiting';
        document.getElementById(`status-${i}`).textContent = 'WAITING';
        document.getElementById(`result-${i}`).style.display = 'none';
      }
      
      document.getElementById('summary').style.display = 'none';
      
      // Run tests sequentially
      await test1_EnvironmentCheck();
      await sleep(500);
      
      const test2Pass = await test2_FunctionAvailability();
      await sleep(500);
      
      if (test2Pass) {
        await test3_GroqAPIConnection();
        await sleep(500);
        
        await test4_LlamaModelTest();
        await sleep(500);
        
        await test5_CustomDataIntegration();
        await sleep(500);
        
        await test6_FullConversationFlow();
      } else {
        // Skip remaining tests if function not available
        for (let i = 3; i <= 6; i++) {
          updateStatus(i, 'fail', '<pre><span class="error-text">‚úó Skipped due to function availability failure</span></pre>');
        }
      }
      
      showSummary();
      
      btn.disabled = false;
      btn.textContent = 'üîÑ Run Tests Again';
    }
  </script>
</body>
</html>
